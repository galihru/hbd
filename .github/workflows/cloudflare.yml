name: Deploy to Cloudflare

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Cloudflare
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Setup Node.js untuk Cloudflare Workers
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      # Setup Ruby dan Bundler
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2' # Sesuaikan dengan versi yang dibutuhkan
          bundler-cache: true

      # Install Dependencies (Node.js + Ruby)
      - name: Install Dependencies
        run: |
          npm ci
          bundle install --jobs 4 --retry 3

      # Install Wrangler untuk Deploy Cloudflare Workers
      - name: Install Wrangler
        run: npm install -g wrangler@3.90.0

      # Debugging untuk memastikan file yang berubah
      - name: Debug Changed Files
        run: git diff --name-only ${{ github.event.before }} ${{ github.sha }}

      # Selective Deploy (Hanya jika file penting berubah)
      - name: Selective Deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_ZONE_ID: ${{ secrets.CF_ZONE_ID }}
        run: |
          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          
          if echo "$CHANGED_FILES" | grep -E '^(worker\.js|index\.html|css/|js/)'; then
            echo "Critical files changed, deploying..."
            wrangler deploy --minify
          else
            echo "No critical files changed, skipping deploy"
            exit 0
          fi

      # Handle Deploy Error
      - name: Handle Deploy Error
        if: failure()
        run: |
          echo "Deployment failed. This might be due to KV usage limits."
          echo "Options:"
          echo "1. Wait for daily limit reset"
          echo "2. Clean up unnecessary KV entries"
          echo "3. Upgrade Cloudflare plan"
